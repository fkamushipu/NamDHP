<!DOCTYPE html>
<html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="description" content="Digital Health Passport">	
      <meta name="keywords" content="health, COVID-19, vaccine, vaccination, test">
      <meta name="author" content="Feni Kamushipu">

      <!--Page title-->
      <title>Nam DHP</title>
      <link rel="icon" href="../images/DHP Done.png" type="image/x-icon">

      <!--Bootstrap 3 style-->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
      
      <!--Styling Sheets-->
      <link rel="stylesheet" href="../style/style.css">
      <link rel="stylesheet" href="../style/profile.css">
      <link rel="stylesheet" href="../style/register.css">

      <!--Ajax Script-->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
      
    
    </head>
    <body>
      <div class="container">
        <div class="main-body">
          <nav class= "navbar  navbar-default " id="top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#topNavigation">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                  <a class="navbar-left" href="#"><img src="../images/Nam-DHP3.png"></a>
                </div>
                <div class="collapse  navbar-collapse" id="topNavigation">
                    <ul class="nav navbar-nav">
                      <li class="breadcrumb-item active"><a href="adminstration.html">Update User </a></li>
                      <li class="breadcrumb-item"><a href="bookings.html">Bookings</a></li>
                     <li class="breadcrumb-item "><a href="addvaccine.html">Add Vaccine</a></li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                      <li><a onclick="logout()"><span class="glyphicon glyphicon-log-in"></span> Logout</a></li>
                    </ul>
                </div>
            </div>
          </nav>
          <div class="container-fluid">
            <div class="row content">
              <div class="col-sm-9">
                <div class="card mb-3" id="AddUser">
                  <h6 class="heading1">Add User Vaccination details</h6>
                  <div class="card-body">
                    <div class="form-group row">
                      <label for="username" class="col-md-4 col-form-label text-md-right">Username:</label>
                      <select class="col-md-6 form-control" id="username">
                          <optgroup>
                              <option selected="selected" >Select Patient</option>
                          </optgroup>
                      
                      </select>
                  </div>
                  <div class="form-group row">
                    <label for="name" class="col-md-4 col-form-label text-md-right"> Patient First name</label>
                    <div class="col-md-6">
                        <input type="text" id="name" class="form-control" name="name" placeholder="Enter patient's First name" readonly />
                    </div>
                  </div>
                  <div class="form-group row">
                    <label for="last_name" class="col-md-4 col-form-label text-md-right"> Patient Last name</label>
                    <div class="col-md-6">
                        <input type="text" id="last_name" class="form-control" name="last_name" placeholder="Enter patient's Last name" readonly/>
                    </div>
                  </div>
                  
                  <div class="form-group row">
                    <label for="vaccine_name" class="col-md-4 col-form-label text-md-right">Vaccines:</label>
                    <select class="col-md-6 form-control" id="vaccine_name" name="vaccine_name">
                        <optgroup>
                            <option selected="selected" >Select the Vaccine</option>
                        </optgroup>
                    
                    </select>
                  </div>
                  <div class="form-group row">
                    <label for="vaccination_status" class="col-md-4 col-form-label text-md-right">Is the patient vaccinated ?</label>
                    <select class="col-md-6 form-control" id="vaccination_status" name="vaccination_status">
                        <optgroup>
                            <option selected="selected" value="true" >Yes</option>
                            <option value="false" >No</option>

                        </optgroup>
                    
                    </select>
                  </div>
                  <div class="form-group row">
                    <button class="btn btn-success btn-lg btn-block" onclick="update_user_btn()" type="submit"  id="update_user">Update Patient data</button>
                  </div>
                </div>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Load React. -->
    <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha512-bnIvzh6FU75ZKxp0GXLH9bewza/OIw6dLVh9ICg0gogclmYGguQJWl8U30WpbsGTqbIiAwxTsbe76DErLq5EDQ==" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"></script>
    
    <!--Sweet alerts script-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script> 

    <!--Ajax and jquery Scripts-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script> 
    
    <!-- Load our React component. -->
    <script src="app.js"></script>

    <script type="text/javascript">

      //Load the list of users in the user's table
      var admin=null;
      window.onload = function(){
          load_user_patient('Patient')
          load_vaccine('Vaccine')
          admin = JSON.parse(sessionStorage.admin_details)
          console.log(admin)
      }

      //Logout Function
    function logout(){
      
      swal.fire({
        type: 'warning',
        title: "Log Out",
        text: "Are you sure?",
        showConfirmButton: 'Yes',
        showCancelButton:'No',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        closeOnConfirm:true,
        closeOnCancel:true,

        }).then((result) => { 
          if (result.value===true) { 
            swal.fire({
            type: 'warning',
            title: "Account Logging out " ,
            showConfirmButton: true,
            timer: 7500
          })
            sessionStorage.clear()
            window.location = "../index.html";
          }
        })
      }
     

      var user_details = null;
      function load_user_patient(id){

        var user_list='';
        $.getJSON("http://localhost:6503/api/users", function(data){

          user_list += '<option value=""> Select '+id+' </option>';
          data.reverse();
          $.each(data, function(key,value){
              if(id != ''){
                user_list += '<option value="'+value.id+'">'+value.id+ " " +value.username+'</option>';
              }
              else{
                  
              }
          });

          $('#username').html(user_list);     
        });
      };
      
      var vaccine_details = null;
      function load_vaccine(id){

        var vaccine_list='';
        $.getJSON("http://localhost:6503/api/Vaccines", function(data){

          vaccine_list += '<option value=""> Select '+id+' </option>';
          data.reverse();
          $.each(data, function(key,value){
              if(id != ''){
                vaccine_list += '<option value="'+value.id+'">' +value.vaccine_name+'</option>';
              }
              else{
                  
              }
          });

          $('#vaccine_name').html(vaccine_list);     
        });
      };
      
      //Function to load vaccine details
      $("#vaccine_name").change(function(){

        var vaccine_id = $("#vaccine_name").val();
        $.ajax({
          url:"http://localhost:6503/api/Vaccines/"+vaccine_id,
          method: 'GET',
          dataType: 'json',
              
          success:function(data){
            console.log(data)
            
            $('#vaccination_status').html(data.vaccination_status);
            $('#vaccine_type_id').html(data.vaccine_type_id);

            
            vaccine_details = data;
                
          },
          error: function(err){
            console.log(err);
          }
        });
      })

      
      //Function to get user's details
      $("#username").change(function(){

        var user_id = $("#username").val();
        $.ajax({
          url:"http://localhost:6503/api/users/"+user_id,
          method: 'GET',
          dataType: 'json',
              
          success:function(data){
            console.log(data)
            $('#id').val(data.id);         
            $('#name').val(data.name);
            $('#last_name').val(data.last_name);
            $('#vaccination_status').val(data.vaccination_status);
            $('#vaccine_type_id').val(data.vaccine_type_id);

            
            user_details = data;
                
          },
          error: function(err){
            console.log(err);
          }
        });
      })

      //function to update users vaccine type and vaccination status
      function update_user_btn(){
        var isValid = true;
        //Check if any user is chosen
        $('select').each(function() {
          if ($.trim($('#username').val()) == '') {
            isValid = false;
            $(this).css({
                "border": "1px solid red",
                "background": "#FFCECE"
            });
            Swal.fire({
            title : "Select a user to be updated",
            type: 'warning',
            showConfirmButton: true,
            timer: 8000
            })
          }
          else {
            $(this).css({
                "border": "",
                "background": ""
            });
          }
        });
        
        //Check if vaccine is chosen
        $('select').each(function() {
            if ($.trim($('#vaccine_name').val()) == '') {
                isValid = false;
                $(this).css({
                    "border": "1px solid red",
                    "background": "#FFCECE"
                });
                Swal.fire({
                title : "Select a Vaccine",
                type: 'warning',
                showConfirmButton: true,
                timer: 8000
                })
            }
            else {
                $(this).css({
                    "border": "",
                    "background": ""
                });
            }
        });
        
        //Check if vaccine status is allocated 
        $('select').each(function() {
          if ($.trim($('#vaccination_status').val()) == '') {
              isValid = false;
              $(this).css({
                  "border": "1px solid red",
                  "background": "#FFCECE"
              });
              Swal.fire({
              title : "Choose vaccination Status",
              type: 'warning',
              showConfirmButton: true,
              timer: 8000
              })
          }
          else {
              $(this).css({
                  "border": "",
                  "background": ""
              });
          }
      });
      
        if(isValid == true)
        {

          user_details.vaccine_type_id = $('#vaccine_name').val();

          //on change of the value vaccine-name set vaccination status value to true regardless if no was chosen
          $('#vaccine_name').on("change", function(){
          user_details.vaccination_status= $('#vaccination_status').val('true');
          })

        console.log(user_details);
        $.ajax({
          url:"http://localhost:6503/api/users/"+user_details.id,
          method: 'PUT',
          dataType: 'json',
            
          data: user_details,
          success:function(user_details){
            console.log(user_details);

            //Success Alert
            Swal.fire({
              title: 'User Vacccine Status Successfully Updated!',
              type: 'success',
              showConfirmButton: true,
              timer: 8000
            });
            sessionStorage.clear()
            window.location ="adminstration.html"
          },
          error: function(err){
            Swal.fire({
              title : "Please fill in all the informations",
              type: 'warning',
              showConfirmButton: true,
              timer: 8000
            })
            console.log(err);
          }
        });
        
       }
      };

    
    </script> 
  </body>
</html>
