<!DOCTYPE html>
<html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="description" content="Digital Health Passport">	
      <meta name="keywords" content="health, COVID-19, vaccine, vaccination, test">
      <meta name="author" content="Feni Kamushipu">

      <!--Page title-->
      <title>Nam DHP</title>
      <link rel="icon" href="../images/DHP Done.png" type="image/x-icon">

      <!--Bootstrap 3 style-->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
      
      <!--Styling Sheets-->
      <link rel="stylesheet" href="../style/style.css">
      <link rel="stylesheet" href="../style/profile.css">
      <link rel="stylesheet" href="../style/register.css">

      <!--Ajax Script-->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
      
    
    </head>
    <body>
      <div class="container">
        <div class="main-body">
            <nav class= "navbar  navbar-default " id="top">
                <div class="container-fluid">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#topNavigation">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                      <a class="navbar-left" href="#"><img src="../images/Nam-DHP3.png"></a>
                    </div>
                    <div class="collapse  navbar-collapse" id="topNavigation">
                        <ul class="nav navbar-nav">
                          <li class="breadcrumb-item active"><a href="adminstration.html">Update User </a></li>
                          <li class="breadcrumb-item"><a href="bookings.html">Bookings</a></li>
                         
                        </ul>
                        <ul class="nav navbar-nav navbar-right">
                          <li><a onclick="logout()"><span class="glyphicon glyphicon-log-in"></span> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
            <div class="container-fluid">
            <div class="row content">
              <div class="col-sm-9">
                <!--Bookings Approval-->
                <div class="card mb-3" id="Bookings">
                  <h6 class="heading1">Bookings</h6>
                  <div class="card-body">
                    <div class="form-group row">
                      <label for="appointment" class="col-md-4 col-form-label text-md-right">Booking: </label>
                      <select class="col-md-6 form-control" id="appointment">
                          <optgroup>
                              <option selected="selected" >Select Booking</option>
                          </optgroup>
                      
                      </select>
                  </div>
                  <div class="form-group row">
                    <label for="booking_name" class="col-md-4 col-form-label text-md-right"> Patient First name</label>
                    <div class="col-md-6">
                        <input type="text" id="booking_name" class="form-control" name="booking_name" placeholder="Enter patient's First name" readonly />
                    </div>
                  </div>
                  <div class="form-group row">
                    <label for="booking_last_name" class="col-md-4 col-form-label text-md-right"> Patient Last name</label>
                    <div class="col-md-6">
                        <input type="text" id="booking_last_name" class="form-control" name="booking_last_name" placeholder="Enter patient's Last name" readonly/>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label for="schedule_date" class="col-md-4 col-form-label text-md-right">Appointment Schedule date</label>
                    <div class="col-md-6">
                        <input type="date" id="schedule_date" class="form-control" name="schedule_date" placeholder="Schedule a date" required/>
                    </div>
                </div>
                  <div class="form-group row">
                    <button class="btn btn-success btn-lg btn-block"  type="submit"  id="send_approval">Approve Booking</button>
                  </div>
                </div>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Load React. -->
    <!-- Note: when deploying, replace "development.js" with "production.min.js". -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha512-bnIvzh6FU75ZKxp0GXLH9bewza/OIw6dLVh9ICg0gogclmYGguQJWl8U30WpbsGTqbIiAwxTsbe76DErLq5EDQ==" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"></script>
    
    <!--Sweet alerts script-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script> 

    <!--Ajax and jquery Scripts-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script> 
    
    <!-- Load our React component. -->
    <script src="app.js"></script>

    <script type="text/javascript">

      //Load the list of users in the user's table
      var admin=null;
      window.onload = function(){
          load_user_patient('Patient')
          load_booking('Booking')
          admin = JSON.parse(sessionStorage.admin_details)
          console.log(admin)
      }

      //Logout function
      function logout(){
        sessionStorage.clear()
        window.location = "../register.html";
      }

      var user_details = null;
      function load_user_patient(id){

        var user_list='';
        $.getJSON("http://localhost:6503/api/users", function(data){

          user_list += '<option value=""> Select '+id+' </option>';
          data.reverse();
          $.each(data, function(key,value){
              if(id != ''){
                user_list += '<option value="'+value.id+'">'+value.id+ " " +value.username+'</option>';
              }
              else{
                  
              }
          });

          $('#username').html(user_list);     
        });
      };
      //Function to get user's details
      $("#username").change(function(){

        var user_id = $("#username").val();
        $.ajax({
          url:"http://localhost:6503/api/users/"+user_id,
          method: 'GET',
          dataType: 'json',
              
          success:function(data){
            console.log(data)
            $('#id').val(data.id);         
            $('#name').val(data.name);
            $('#last_name').val(data.last_name);
            $('#vaccinated').val(data.vaccinated);

            if (data.vaccination_type == null) {
              $('#vaccine_type').append('<option selected="Selected" Value="Not Vaccinated">Not Vaccinated</option>');
             // $('#vaccinated').append('<option selected="Selected" Value="No">No</option>');
            }
            else{
              $('#vaccine_type').val(data.vaccination_type);
            }
            user_details = data;
                
          },
          error: function(err){
            console.log(err);
          }
        });
      })

      //function to update users vaccine type and vaccination status
      function update_user_btn(){
        user_details.vaccinated= $('#vaccinated').val();
        user_details.vaccination_type = $('#vaccine_type').val();
        console.log(user_details);

        $.ajax({
          url:"http://localhost:6503/api/users/"+user_details.id,
          method: 'PUT',
          dataType: 'json',
            
          data: user_details,
          success:function(user_details){
            console.log(user_details)

            //Success Alert
            Swal.fire({
              title: 'User Vacccine Status Successfully Updated!',
              type: 'success',
              showConfirmButton: false,
              timer: 2500
            });
          },
          error: function(err){
            console.log(err);
          }
        });
      };


      //Bookings Approval 
      var booking = null;
      function load_booking(id){

        var booking_list='';
        $.getJSON("http://localhost:6503/api/appointments", function(data){

          booking_list += '<option value=""> Select '+id+' </option>';
          data.reverse();
          $.each(data, function(key,value){
              if(id != ''){
                booking_list += '<option value="'+value.user_id+'">'+value.reason+'</option>';
              }
              else{
                  
              }
          });

          $('#appointment').html(booking_list);     
        });
      };
      var user_booking = null;
      //Function to get user's details
      $("#appointment").change(function(){

        var booking_id = $("#appointment").val();

        $.ajax({
          url:"http://localhost:6503/api/users/"+booking_id,
          method: 'GET',
          dataType: 'json',
              
          success:function(data){
            console.log(data)
            user_booking = data;
            $('#booking_name').val(data.name);
            $('#booking_last_name').val(data.last_name);
         

           
          },
          error: function(err){
            console.log(err);
          }
        });
    
      })
     
      $("#send_approval").click(function(e){
        
        var email_subject = "NAMDHP Booking"
        var email_body = "Dear: "+user_booking.name +" "+ user_booking.last_name+ "\n" +" , this is to inform you that your booking was approved and is scheduled on the: "+$("#schedule_date").val()+" at UNAM Clinic! Yours faithfully  "+ admin.admin_name+ " "+ admin.admin_lastname + "."
        window.open('mailto:'+user_booking.email+'?subject='+email_subject+'&body='+email_body+'');
      })

      
    </script> 
  </body>
</html>
